version: '3.8'

services:
  # PostgreSQL database
  postgres:
    image: postgres:15-alpine
    container_name: fluxindexer-postgres
    shm_size: 512m
    environment:
      POSTGRES_DB: fluxindexer
      POSTGRES_USER: fluxindexer
      POSTGRES_PASSWORD: ${DB_PASSWORD:-fluxpass}
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./src/database/schema.sql:/docker-entrypoint-initdb.d/schema.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U fluxindexer -d fluxindexer"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - fluxindexer

  # FluxIndexer (with bundled Flux daemon + Dashboard)
  indexer:
    build: .
    container_name: fluxindexer
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # Flux Daemon RPC Configuration (internal bundled daemon)
      FLUX_RPC_URL: http://localhost:16124
      FLUX_RPC_USER: ${FLUX_RPC_USER:-fluxrpc}
      FLUX_RPC_PASSWORD: ${FLUX_RPC_PASSWORD:-change_this_password}

      # Database Configuration
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: fluxindexer
      DB_USER: fluxindexer
      DB_PASSWORD: ${DB_PASSWORD:-fluxpass}

      # Indexer Configuration
      INDEXER_BATCH_SIZE: ${INDEXER_BATCH_SIZE:-100}
      INDEXER_POLLING_INTERVAL: ${INDEXER_POLLING_INTERVAL:-5000}
      INDEXER_START_HEIGHT: ${INDEXER_START_HEIGHT:-0}

      # API Configuration
      API_PORT: 3002
      API_HOST: 0.0.0.0

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-info}
    ports:
      - "3002:3002"      # API + Dashboard (bundled frontend)
      - "16124:16124"    # Expose Flux RPC (optional, for debugging)
    volumes:
      - flux-data:/home/flux/.flux  # Persist blockchain data
      - zcash-params:/home/flux/.zcash-params  # Zcash parameters (auto-downloaded on first run)
    restart: unless-stopped
    networks:
      - fluxindexer
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:3002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s  # Increased to allow fluxd to start

networks:
  fluxindexer:
    driver: bridge

volumes:
  postgres-data:
  flux-data:
  zcash-params:
