version: '3.8'

services:
  # TimescaleDB database (PostgreSQL with time-series optimization)
  postgres:
    image: timescale/timescaledb:latest-pg15
    container_name: fluxindexer-postgres
    shm_size: 512m
    environment:
      POSTGRES_DB: fluxindexer
      POSTGRES_USER: fluxindexer
      # SECURITY WARNING: Change default password before deployment!
      # Set DB_PASSWORD environment variable to override
      POSTGRES_PASSWORD: ${DB_PASSWORD:-CHANGE_THIS_PASSWORD}
    ports:
      # Security: Only expose to localhost (not 0.0.0.0)
      - "127.0.0.1:5432:5432"
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 16G  # Current usage: ~12GB, allows growth headroom
        reservations:
          cpus: '2'
          memory: 8G
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./src/database/schema.sql:/docker-entrypoint-initdb.d/schema.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U fluxindexer -d fluxindexer"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - fluxindexer

  # FluxIndexer (with bundled Flux daemon + Dashboard)
  indexer:
    build: .
    container_name: fluxindexer
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # Flux Daemon RPC Configuration (internal bundled daemon)
      FLUX_RPC_URL: http://localhost:16124
      FLUX_RPC_USER: ${FLUX_RPC_USER:-fluxrpc}
      # SECURITY WARNING: Change default password before deployment!
      # Set FLUX_RPC_PASSWORD environment variable to override
      FLUX_RPC_PASSWORD: ${FLUX_RPC_PASSWORD:-CHANGE_THIS_RPC_PASSWORD}

      # Database Configuration
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: fluxindexer
      DB_USER: fluxindexer
      # SECURITY WARNING: Must match POSTGRES_PASSWORD above
      # Set DB_PASSWORD environment variable to override
      DB_PASSWORD: ${DB_PASSWORD:-CHANGE_THIS_PASSWORD}

      # Indexer Configuration
      INDEXER_BATCH_SIZE: ${INDEXER_BATCH_SIZE:-100}
      INDEXER_POLLING_INTERVAL: ${INDEXER_POLLING_INTERVAL:-5000}
      INDEXER_START_HEIGHT: ${INDEXER_START_HEIGHT:-0}

      # API Configuration
      API_PORT: 42067
      API_HOST: 0.0.0.0

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-info}
    ports:
      - "42067:42067"    # API + Dashboard (bundled frontend)
      # Security: RPC port only exposed to localhost for debugging
      - "127.0.0.1:16124:16124"    # Flux RPC (localhost only)
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 6G  # Current usage: ~2GB, allows growth headroom
        reservations:
          cpus: '2'
          memory: 2G
    volumes:
      - flux-data:/home/flux/.flux  # Persist blockchain data
      - zcash-params:/home/flux/.zcash-params  # Zcash parameters (auto-downloaded on first run)
    restart: unless-stopped
    networks:
      - fluxindexer
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:42067/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s  # Increased to allow fluxd to start

networks:
  fluxindexer:
    driver: bridge

volumes:
  postgres-data:
  flux-data:
  zcash-params:
